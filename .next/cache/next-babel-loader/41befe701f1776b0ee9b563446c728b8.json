{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport React from \"react\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport \"../styles/pure/pure-min.css\";\nimport \"../styles/pure/grids-responsive-min.css\";\nimport \"../styles/pure/main-grid.css\";\nimport \"../styles/pure/main.css\";\nimport \"../styles/globals.css\";\nimport { encrypt, decrypt } from \"../utils/crypt\";\nimport AdminLayout from \"../components/layouts/adminLayout\";\nimport { Provider } from \"react-redux\";\nimport { PersistGate } from \"redux-persist/integration/react\";\nimport withReduxStore from \"../lib/with-redux-store\";\nimport App, { Container } from 'next/app';\nimport { userConstants, routeConstants } from '../constants';\nimport { userActions } from \"../actions\";\nimport fetch from \"isomorphic-unfetch\";\nimport { route } from \"next/dist/next-server/server/router\";\nimport { getPageList } from \"../utils/helpers\";\nimport Cookies from \"universal-cookie\";\n\nfunction MyApp(_ref) {\n  var Component = _ref.Component,\n      pageProps = _ref.pageProps,\n      reduxStore = _ref.reduxStore,\n      persistor = _ref.persistor;\n  var Layout = Component.Layout || AdminLayout;\n  return __jsx(React.Fragment, null, __jsx(Provider, {\n    store: reduxStore\n  }, __jsx(PersistGate, {\n    loading: null,\n    persistor: persistor\n  }, __jsx(Layout, pageProps, __jsx(Component, pageProps)))), __jsx(\"script\", {\n    type: \"text/javascript\",\n    src: \"/js/menu.js\"\n  }), __jsx(\"script\", {\n    type: \"text/javascript\",\n    src: \"/js/grid.js\"\n  }), __jsx(\"script\", {\n    defer: true,\n    type: \"text/javascript\",\n    src: \"/js/ui.js\"\n  }));\n}\n\n_c = MyApp;\n\nMyApp.getInitialProps = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(appContext) {\n    var appProps, encrytedToken, token, user, _result$data, _result$data2, headers, response, result, pathname, payload, currentPath;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _context.next = 2;\n            return App.getInitialProps(appContext);\n\n          case 2:\n            appProps = _context.sent;\n            encrytedToken = null;\n            token = null;\n            user = null;\n\n            try {\n              if (appContext.ctx.req && appContext.ctx.req.headers.cookie) {\n                encrytedToken = new Cookies(appContext.ctx.req.headers.cookie).get(\"atk\");\n                token = decrypt(encrytedToken);\n              }\n            } catch (error) {}\n\n            if (!token) {\n              _context.next = 18;\n              break;\n            }\n\n            // make request to server for a refresh token\n            headers = {\n              'Accept': 'application/json',\n              'Content-Type': 'application/json'\n            };\n            headers['Authorization'] = 'Bearer ' + token;\n            _context.next = 12;\n            return fetch(routeConstants.REFRESH_TOKEN, {\n              method: \"POST\",\n              headers: headers\n            }, []);\n\n          case 12:\n            response = _context.sent;\n            _context.next = 15;\n            return response.json();\n\n          case 15:\n            result = _context.sent;\n            user = (_result$data = result.data) === null || _result$data === void 0 ? void 0 : _result$data.user;\n            token = (_result$data2 = result.data) === null || _result$data2 === void 0 ? void 0 : _result$data2.token;\n\n          case 18:\n            pathname = appContext.router.pathname;\n\n            if (user && user != undefined) {\n              payload = {\n                user: user,\n                token: token\n              };\n              appContext.ctx.reduxStore.dispatch({\n                type: userConstants.LOGIN_SUCCESS,\n                payload: payload\n              });\n              currentPath = appContext.ctx.req.path; // check that we are in SSR mode (NOT static and NOT client-side)\n\n              if (false && appContext.ctx.res.writeHead) {\n                // if path is / or login and we already have accessToken then change to /home\n                if (pathname === '/login' || pathname === '/' || pathname === '/index') {\n                  pathname = '/home';\n                } //route to the path, when it has changed\n\n\n                if (pathname !== currentPath) {\n                  appContext.ctx.res.writeHead(302, {\n                    Location: pathname\n                  });\n                  appContext.ctx.res.end();\n                }\n              }\n            } else {\n              if (false && appContext.ctx.res.writeHead) {\n                if (pathname !== \"/\") {\n                  appContext.ctx.res.writeHead(302, {\n                    Location: \"/\"\n                  });\n                  appContext.ctx.res.end();\n                }\n              }\n            }\n\n            return _context.abrupt(\"return\", _objectSpread({}, appProps));\n\n          case 21:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function (_x) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nexport default _c2 = withReduxStore(MyApp);\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"MyApp\");\n$RefreshReg$(_c2, \"%default%\");","map":{"version":3,"sources":["/Users/babatundeolajide/Projects/ExpressGrub/AdminClient/src/pages/_app.js"],"names":["encrypt","decrypt","AdminLayout","Provider","PersistGate","withReduxStore","App","Container","userConstants","routeConstants","userActions","fetch","route","getPageList","Cookies","MyApp","Component","pageProps","reduxStore","persistor","Layout","getInitialProps","appContext","appProps","encrytedToken","token","user","ctx","req","headers","cookie","get","error","REFRESH_TOKEN","method","response","json","result","data","pathname","router","undefined","payload","dispatch","type","LOGIN_SUCCESS","currentPath","path","res","writeHead","Location","end"],"mappings":";;;;;;;;;;AACA,OAAO,6BAAP;AACA,OAAO,yCAAP;AACA,OAAO,8BAAP;AACA,OAAO,yBAAP;AAEA,OAAO,uBAAP;AAEA,SAAQA,OAAR,EAAiBC,OAAjB,QAA+B,gBAA/B;AAIA,OAAOC,WAAP,MAAwB,mCAAxB;AACA,SAASC,QAAT,QAAyB,aAAzB;AACA,SAASC,WAAT,QAA4B,iCAA5B;AACA,OAAOC,cAAP,MAA2B,yBAA3B;AACA,OAAOC,GAAP,IAAaC,SAAb,QAA6B,UAA7B;AACA,SAASC,aAAT,EAAwBC,cAAxB,QAA8C,cAA9C;AACA,SAASC,WAAT,QAA4B,YAA5B;AACA,OAAOC,KAAP,MAAkB,oBAAlB;AACA,SAASC,KAAT,QAAsB,qCAAtB;AACA,SAASC,WAAT,QAA4B,kBAA5B;AAEA,OAAOC,OAAP,MAAoB,kBAApB;;AAGA,SAASC,KAAT,OAAgE;AAAA,MAA/CC,SAA+C,QAA/CA,SAA+C;AAAA,MAApCC,SAAoC,QAApCA,SAAoC;AAAA,MAAzBC,UAAyB,QAAzBA,UAAyB;AAAA,MAAbC,SAAa,QAAbA,SAAa;AAC9D,MAAMC,MAAM,GAAGJ,SAAS,CAACI,MAAV,IAAoBlB,WAAnC;AAGA,SACE,4BACA,MAAC,QAAD;AAAU,IAAA,KAAK,EAAEgB;AAAjB,KACE,MAAC,WAAD;AAAa,IAAA,OAAO,EAAE,IAAtB;AAA4B,IAAA,SAAS,EAAEC;AAAvC,KACE,MAAC,MAAD,EAAYF,SAAZ,EACE,MAAC,SAAD,EAAeA,SAAf,CADF,CADF,CADF,CADA,EASE;AAAQ,IAAA,IAAI,EAAC,iBAAb;AAA+B,IAAA,GAAG,EAAC;AAAnC,IATF,EAUE;AAAQ,IAAA,IAAI,EAAC,iBAAb;AAA+B,IAAA,GAAG,EAAC;AAAnC,IAVF,EAWE;AAAQ,IAAA,KAAK,MAAb;AAAc,IAAA,IAAI,EAAC,iBAAnB;AAAqC,IAAA,GAAG,EAAC;AAAzC,IAXF,CADF;AAeD;;KAnBQF,K;;AAqBTA,KAAK,CAACM,eAAN;AAAA,uEAAwB,iBAAOC,UAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAKGhB,GAAG,CAACe,eAAJ,CAAoBC,UAApB,CALH;;AAAA;AAKdC,YAAAA,QALc;AAOhBC,YAAAA,aAPgB,GAOA,IAPA;AAQhBC,YAAAA,KARgB,GAQR,IARQ;AAShBC,YAAAA,IATgB,GAST,IATS;;AAWpB,gBAAI;AAEF,kBAAGJ,UAAU,CAACK,GAAX,CAAeC,GAAf,IAAsBN,UAAU,CAACK,GAAX,CAAeC,GAAf,CAAmBC,OAAnB,CAA2BC,MAApD,EAA4D;AAC1DN,gBAAAA,aAAa,GAAG,IAAIV,OAAJ,CAAYQ,UAAU,CAACK,GAAX,CAAeC,GAAf,CAAmBC,OAAnB,CAA2BC,MAAvC,EAA+CC,GAA/C,CAAmD,KAAnD,CAAhB;AACAN,gBAAAA,KAAK,GAAGxB,OAAO,CAACuB,aAAD,CAAf;AACD;AAEF,aAPD,CAOE,OAAOQ,KAAP,EAAc,CAEf;;AApBmB,iBAyBhBP,KAzBgB;AAAA;AAAA;AAAA;;AA2BlB;AACMI,YAAAA,OA5BY,GA4BF;AACd,wBAAU,kBADI;AAEd,8BAAgB;AAFF,aA5BE;AAiClBA,YAAAA,OAAO,CAAC,eAAD,CAAP,GAA2B,YAAYJ,KAAvC;AAjCkB;AAAA,mBAoCKd,KAAK,CAACF,cAAc,CAACwB,aAAhB,EAA8B;AACxDC,cAAAA,MAAM,EAAC,MADiD;AAExDL,cAAAA,OAAO,EAAPA;AAFwD,aAA9B,EAG1B,EAH0B,CApCV;;AAAA;AAoCZM,YAAAA,QApCY;AAAA;AAAA,mBAyCGA,QAAQ,CAACC,IAAT,EAzCH;;AAAA;AAyCZC,YAAAA,MAzCY;AA0ClBX,YAAAA,IAAI,mBAAGW,MAAM,CAACC,IAAV,iDAAG,aAAaZ,IAApB;AACAD,YAAAA,KAAK,oBAAGY,MAAM,CAACC,IAAV,kDAAG,cAAab,KAArB;;AA3CkB;AA+ChBc,YAAAA,QA/CgB,GA+CLjB,UAAU,CAACkB,MAAX,CAAkBD,QA/Cb;;AAoDpB,gBAAIb,IAAI,IAAIA,IAAI,IAAIe,SAApB,EAA8B;AAEtBC,cAAAA,OAFsB,GAEZ;AAAChB,gBAAAA,IAAI,EAAJA,IAAD;AAAOD,gBAAAA,KAAK,EAALA;AAAP,eAFY;AAG5BH,cAAAA,UAAU,CAACK,GAAX,CAAeT,UAAf,CAA0ByB,QAA1B,CAAmC;AAACC,gBAAAA,IAAI,EAACpC,aAAa,CAACqC,aAApB;AAAmCH,gBAAAA,OAAO,EAAPA;AAAnC,eAAnC;AAEMI,cAAAA,WALsB,GAKRxB,UAAU,CAACK,GAAX,CAAeC,GAAf,CAAmBmB,IALX,EAQ5B;;AACA,kBAAI,SAAiCzB,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBC,SAAxD,EAAmE;AAGjE;AACA,oBAAIV,QAAQ,KAAK,QAAb,IAAyBA,QAAQ,KAAK,GAAtC,IAA6CA,QAAQ,KAAK,QAA9D,EAAwE;AACtEA,kBAAAA,QAAQ,GAAG,OAAX;AACD,iBANgE,CAQjE;;;AAEA,oBAAGA,QAAQ,KAAKO,WAAhB,EAA4B;AAC1BxB,kBAAAA,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBC,SAAnB,CAA6B,GAA7B,EAAkC;AAAEC,oBAAAA,QAAQ,EAAEX;AAAZ,mBAAlC;AACAjB,kBAAAA,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBG,GAAnB;AACD;AAGF;AACF,aA1BD,MA0BO;AAEL,kBAAI,SAAiC7B,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBC,SAAxD,EAAmE;AACjE,oBAAGV,QAAQ,KAAK,GAAhB,EAAoB;AAClBjB,kBAAAA,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBC,SAAnB,CAA6B,GAA7B,EAAkC;AAAEC,oBAAAA,QAAQ,EAAE;AAAZ,mBAAlC;AACA5B,kBAAAA,UAAU,CAACK,GAAX,CAAeqB,GAAf,CAAmBG,GAAnB;AACD;AACF;AACF;;AAtFmB,+DAyFR5B,QAzFQ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAxB;;AAAA;AAAA;AAAA;AAAA;;AA4FA,qBAAelB,cAAc,CAACU,KAAD,CAA7B","sourcesContent":["\nimport \"../styles/pure/pure-min.css\"\nimport \"../styles/pure/grids-responsive-min.css\"\nimport \"../styles/pure/main-grid.css\"\nimport \"../styles/pure/main.css\"\n\nimport \"../styles/globals.css\"\n\nimport {encrypt, decrypt} from \"../utils/crypt\";\n\n\n\nimport AdminLayout from \"../components/layouts/adminLayout\";\nimport { Provider } from \"react-redux\"\nimport { PersistGate } from \"redux-persist/integration/react\"\nimport withReduxStore from \"../lib/with-redux-store\";\nimport App, {Container} from 'next/app'\nimport { userConstants, routeConstants } from '../constants';\nimport { userActions } from \"../actions\"\nimport fetch from \"isomorphic-unfetch\";\nimport { route } from \"next/dist/next-server/server/router\"\nimport { getPageList } from \"../utils/helpers\"\n\nimport Cookies from \"universal-cookie\";\n\n\nfunction MyApp({ Component, pageProps, reduxStore, persistor }) {\n  const Layout = Component.Layout || AdminLayout;\n  \n \n  return (\n    <>\n    <Provider store={reduxStore}>\n      <PersistGate loading={null} persistor={persistor}>\n        <Layout {...pageProps}>\n          <Component {...pageProps} />\n        </Layout>\n      </PersistGate>\n    </Provider>\n      \n      <script type=\"text/javascript\" src=\"/js/menu.js\" />\n      <script type=\"text/javascript\" src=\"/js/grid.js\" />\n      <script defer type=\"text/javascript\" src=\"/js/ui.js\" />\n    </>\n  )\n}\n\nMyApp.getInitialProps = async (appContext) => {\n\n    \n    \n\n    const appProps = await App.getInitialProps(appContext);\n    \n    var encrytedToken = null\n    var token = null\n    var user = null\n\n    try {\n\n      if(appContext.ctx.req && appContext.ctx.req.headers.cookie) {\n        encrytedToken = new Cookies(appContext.ctx.req.headers.cookie).get(\"atk\")\n        token = decrypt(encrytedToken)\n      }\n      \n    } catch (error) {\n      \n    }\n    \n\n    \n\n    if (token){\n\n      // make request to server for a refresh token\n      const headers = {\n        'Accept': 'application/json',\n        'Content-Type': 'application/json'\n        }\n  \n      headers['Authorization'] = 'Bearer ' + token\n  \n      \n      const response = await fetch(routeConstants.REFRESH_TOKEN,{\n        method:\"POST\",\n        headers\n      },[])\n  \n      const result = await response.json()\n      user = result.data?.user;\n      token = result.data?.token\n    }\n    \n\n    let pathname = appContext.router.pathname\n    \n  \n    \n    \n    if (user && user != undefined){\n      \n      const payload = {user, token}\n      appContext.ctx.reduxStore.dispatch({type:userConstants.LOGIN_SUCCESS, payload})\n      \n      const currentPath = appContext.ctx.req.path\n      \n\n      // check that we are in SSR mode (NOT static and NOT client-side)\n      if (typeof window === \"undefined\" && appContext.ctx.res.writeHead) {\n        \n        \n        // if path is / or login and we already have accessToken then change to /home\n        if (pathname === '/login' || pathname === '/' || pathname === '/index') {\n          pathname = '/home'  \n        }\n\n        //route to the path, when it has changed\n        \n        if(pathname !== currentPath){\n          appContext.ctx.res.writeHead(302, { Location: pathname });\n          appContext.ctx.res.end();\n        }\n        \n        \n      }\n    } else {\n\n      if (typeof window === \"undefined\" && appContext.ctx.res.writeHead) {\n        if(pathname !== \"/\"){\n          appContext.ctx.res.writeHead(302, { Location: \"/\" });\n          appContext.ctx.res.end();\n        }\n      }\n    }\n\n\n    return { ...appProps};\n}\n\nexport default withReduxStore(MyApp)\n"]},"metadata":{},"sourceType":"module"}